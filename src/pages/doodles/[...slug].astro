---
import { getCollection, getEntry, render } from "astro:content";
import sitemap from "sitemap-ext:config";
import FormattedDate from "@/components/FormattedDate.astro";
import { ImageViewer } from "@/components/image-viewer";
import ContentNavigation from "@/components/navigation/ContentNavigation.astro";
import ShareButtons from "@/components/ShareButtons.astro";
import { SITE_DESCRIPTION, SITE_TITLE } from "@/consts";
import MainLayout from "@/layouts/MainLayout.astro";
import { getAdjacentContent } from "@/lib/navigation";
import "@/styles/article.css";

sitemap(async ({ addToSitemap }) => {
  const doodles = await getCollection("doodles");

  addToSitemap(
    doodles.map((item) => ({
      slug: item.id,
    })),
  );
});

const { slug } = Astro.params;
if (slug === undefined) {
  return new Response(null, {
    status: 400,
    statusText: "Bad Request: Slug is missing",
  });
}

const slugId = Array.isArray(slug) ? slug.join("/") : slug;
const doodle = await getEntry("doodles", slugId);

if (!doodle) {
  return Astro.redirect("/404");
}

const { Content } = await render(doodle);
const origin = Astro.url.origin;
const title = doodle.data.title;
const description = doodle.data.description || SITE_DESCRIPTION;
const pageTitle = `${title} | ${SITE_TITLE}`;
const allDoodles = await getCollection("doodles");
const adjacentContent = getAdjacentContent(allDoodles, doodle.id);
---

<MainLayout
  title={pageTitle}
  description={description}
  type="article"
  publishedTime={doodle.data.pubDate.toISOString()}
  modifiedTime={doodle.data.endDate.toISOString()}
  section="Doodle"
>
  <article class="container px-4 md:px-6 prose-teahouse">
    <div class="max-w-screen-lg mx-auto p-4">
      <div class="mb-4 py-4 text-center leading-none">
        <h1 class="mb-2 font-serif">{title}</h1>
      </div>
      <div class="flex items-center justify-between">
        <div><FormattedDate date={doodle.data.pubDate} /></div>
        <div class="flex items-center gap-2 lg:justify-end">
          <ShareButtons
            url={`${origin}/doodles/${doodle.id}`}
            title={title}
            description={description}
          />
        </div>
      </div>
      <hr />
    </div>
    <div class="max-w-screen-lg mx-auto p-4 text-lg">
      <Content />
    </div>
    <div class="max-w-screen-lg mx-auto p-4">
      <ContentNavigation
        adjacentContent={adjacentContent}
        contentType="doodles"
      />
    </div>
  </article>
  <ImageViewer selector="article img" client:load />
</MainLayout>
